import React, { useState, useRef, useEffect } from 'react';
import { Camera, Upload, X, Sparkles, TrendingUp, Zap, Clock } from 'lucide-react';

export default function HackLens() {
  const [image, setImage] = useState(null);
  const [analyzing, setAnalyzing] = useState(false);
  const [analysis, setAnalysis] = useState(null);
  const [showCamera, setShowCamera] = useState(false);
  const [stream, setStream] = useState(null);
  const [activeTab, setActiveTab] = useState('outfit');
  const [showIntro, setShowIntro] = useState(true);
  const [mousePos, setMousePos] = useState({ x: 0, y: 0 });
  const videoRef = useRef(null);
  const canvasRef = useRef(null);
  const fileInputRef = useRef(null);

  useEffect(() => {
    const timer = setTimeout(() => setShowIntro(false), 4500);
    const handleMouseMove = (e) => {
      if (showIntro) {
        setMousePos({
          x: (e.clientX / window.innerWidth - 0.5) * 20,
          y: (e.clientY / window.innerHeight - 0.5) * 20
        });
      }
    };
    window.addEventListener('mousemove', handleMouseMove);
    return () => {
      clearTimeout(timer);
      window.removeEventListener('mousemove', handleMouseMove);
      if (stream) stream.getTracks().forEach(track => track.stop());
    };
  }, [showIntro, stream]);

  const startCamera = async () => {
    try {
      const mediaStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
      setStream(mediaStream);
      setShowCamera(true);
      if (videoRef.current) videoRef.current.srcObject = mediaStream;
    } catch (err) {
      alert('Camera access denied. Please allow camera permission and try again.');
    }
  };

  const stopCamera = () => {
    if (stream) {
      stream.getTracks().forEach(track => track.stop());
      setStream(null);
    }
    setShowCamera(false);
  };

  const capturePhoto = () => {
    if (videoRef.current && canvasRef.current) {
      const video = videoRef.current;
      const canvas = canvasRef.current;
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      canvas.getContext('2d').drawImage(video, 0, 0);
      const imageData = canvas.toDataURL('image/jpeg');
      setImage(imageData);
      stopCamera();
      analyzeImage(imageData);
    }
  };

  const handleFileUpload = (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (event) => {
        setImage(event.target.result);
        analyzeImage(event.target.result);
      };
      reader.readAsDataURL(file);
    }
  };

  const analyzeImage = async (imgData) => {
    setAnalyzing(true);
    try {
      const base64Data = imgData.split(',')[1];
      const promptText = 'Analyze this image and provide JSON with: outfit (vibe, description, rating 1-10, categories with scores, suggestions with icon/title/desc/priority), colors (primary array, accent, description, mood, recommendations), skincare (metrics with label/opposite/value, tips array, productSuggestions with icon/type/benefit/when). Use trendy Gen-Z language. Respond only with valid JSON.';
      
      const response = await fetch("https://api.anthropic.com/v1/messages", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          model: "claude-sonnet-4-20250514",
          max_tokens: 4000,
          messages: [{
            role: "user",
            content: [
              { type: "image", source: { type: "base64", media_type: "image/jpeg", data: base64Data } },
              { type: "text", text: promptText }
            ]
          }]
        })
      });

      const data = await response.json();
      const text = data.content.find(c => c.type === 'text')?.text || '';
      const cleanJson = text.replace(/```json\n?|\n?```/g, '').trim();
      const aiAnalysis = JSON.parse(cleanJson);
      
      setAnalysis({
        ...aiAnalysis,
        quickActions: [
          { icon: 'ðŸ“¸', label: 'Save Analysis', action: 'save' },
          { icon: 'ðŸ”„', label: 'Compare Looks', action: 'compare' },
          { icon: 'ðŸ’¡', label: 'Get More Tips', action: 'tips' }
        ]
      });
    } catch (error) {
      console.error('Analysis error:', error);
      alert('Analysis failed. Please try again.');
    }
    setAnalyzing(false);
  };

  const reset = () => {
    setImage(null);
    setAnalysis(null);
    setActiveTab('outfit');
    stopCamera();
  };

  if (!image && !showCamera) {
    return (
      <div className="min-h-screen bg-black flex flex-col relative overflow-hidden">
        {showIntro && (
          <div className="fixed inset-0 z-50 pointer-events-none flex items-center justify-center" style={{ transform: 'translate(' + mousePos.x + 'px, ' + mousePos.y + 'px)' }}>
            <div className="absolute" style={{ width: '100px', height: '100px', borderRadius: '50%', background: 'radial-gradient(circle at 30% 30%, rgba(255,255,255,0.95), rgba(255,255,255,0.85))', boxShadow: '0 0 60px 30px rgba(255,255,255,0.3), inset 0 0 40px rgba(255,255,255,0.5)', animation: 'bubbleExpand 3.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards, bubbleDissolve 1s 3.5s ease-out forwards', filter: 'blur(0px)' }} />
          </div>
        )}

        <style>{`
          @keyframes bubbleExpand { 0% { transform: scale(0.1); opacity: 1; } 100% { transform: scale(35); opacity: 0.95; } }
          @keyframes bubbleDissolve { 0% { opacity: 0.95; filter: blur(0px); } 100% { opacity: 0; filter: blur(20px); transform: scale(36); } }
          @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-10px); } }
          @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
          .hover-lift { transition: transform 0.3s ease, box-shadow 0.3s ease; }
          .hover-lift:hover { transform: translateY(-5px); box-shadow: 0 10px 30px rgba(59, 130, 246, 0.3); }
        `}</style>

        <div className="bg-gradient-to-br from-blue-600 to-blue-400 px-6 py-8 relative overflow-hidden">
          <div className="absolute inset-0 opacity-10">
            <div className="absolute top-10 left-10 w-32 h-32 bg-white rounded-full" style={{ animation: 'float 6s ease-in-out infinite' }} />
            <div className="absolute bottom-10 right-10 w-24 h-24 bg-white rounded-full" style={{ animation: 'float 8s ease-in-out infinite 2s' }} />
          </div>
          <div className="relative flex items-center gap-3 mb-2">
            <div className="w-14 h-14 bg-white rounded-2xl flex items-center justify-center" style={{ animation: 'pulse 3s ease-in-out infinite' }}>
              <div className="w-10 h-10 border-4 border-blue-500 rounded-full flex items-center justify-center">
                <Sparkles className="w-5 h-5 text-blue-500" />
              </div>
            </div>
            <div>
              <h1 className="text-white text-3xl font-bold">HackLens</h1>
              <p className="text-blue-100 text-sm">AI-Powered Visual Intelligence</p>
            </div>
          </div>
        </div>

        <div className="flex-1 px-6 py-8 bg-gray-950">
          <div className="max-w-md mx-auto">
            <h2 className="text-white text-xl font-semibold mb-3">Start Your Analysis</h2>
            <p className="text-gray-400 text-sm mb-6">Get instant insights on your style, colors, and skincare</p>
            
            <div className="space-y-4 mb-8">
              <button onClick={startCamera} className="w-full py-4 bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-700 hover:to-blue-600 text-white rounded-xl font-medium flex items-center justify-center gap-3 transition-all hover-lift">
                <Camera className="w-5 h-5" />Take a Photo
              </button>
              <button onClick={() => fileInputRef.current?.click()} className="w-full py-4 bg-gray-800 hover:bg-gray-700 text-white rounded-xl font-medium flex items-center justify-center gap-3 transition-all hover-lift">
                <Upload className="w-5 h-5" />Upload from Gallery
              </button>
            </div>

            <input ref={fileInputRef} type="file" accept="image/*" onChange={handleFileUpload} className="hidden" />

            <div className="bg-gradient-to-br from-purple-900/30 to-blue-900/30 rounded-xl p-6 border border-purple-500/20 mb-6">
              <div className="flex items-center gap-2 mb-4">
                <Zap className="w-5 h-5 text-yellow-400" />
                <h3 className="text-white font-semibold">What You'll Get</h3>
              </div>
              <div className="space-y-3">
                <div className="flex items-start gap-3">
                  <div className="w-8 h-8 bg-blue-500/20 rounded-lg flex items-center justify-center flex-shrink-0">
                    <TrendingUp className="w-4 h-4 text-blue-400" />
                  </div>
                  <div>
                    <p className="text-white text-sm font-medium">Style Rating & Vibe Check</p>
                    <p className="text-gray-400 text-xs">Detailed outfit scoring with trend analysis</p>
                  </div>
                </div>
                <div className="flex items-start gap-3">
                  <div className="w-8 h-8 bg-purple-500/20 rounded-lg flex items-center justify-center flex-shrink-0">
                    <Sparkles className="w-4 h-4 text-purple-400" />
                  </div>
                  <div>
                    <p className="text-white text-sm font-medium">Smart Color Recommendations</p>
                    <p className="text-gray-400 text-xs">Complementary colors and styling suggestions</p>
                  </div>
                </div>
                <div className="flex items-start gap-3">
                  <div className="w-8 h-8 bg-pink-500/20 rounded-lg flex items-center justify-center flex-shrink-0">
                    <Clock className="w-4 h-4 text-pink-400" />
                  </div>
                  <div>
                    <p className="text-white text-sm font-medium">Personalized Skincare Tips</p>
                    <p className="text-gray-400 text-xs">Product recommendations based on your skin</p>
                  </div>
                </div>
              </div>
            </div>

            <div className="grid grid-cols-2 gap-4">
              <div className="bg-gray-900 rounded-xl p-4 border border-gray-800 hover-lift cursor-pointer">
                <div className="text-2xl mb-2">ðŸ‘”</div>
                <h3 className="text-white font-semibold text-sm mb-1">Outfit Analysis</h3>
                <p className="text-gray-400 text-xs">Get style ratings and vibe checks</p>
              </div>
              <div className="bg-gray-900 rounded-xl p-4 border border-gray-800 hover-lift cursor-pointer">
                <div className="text-2xl mb-2">ðŸŽ¨</div>
                <h3 className="text-white font-semibold text-sm mb-1">Color Palette</h3>
                <p className="text-gray-400 text-xs">Discover your color harmony</p>
              </div>
              <div className="bg-gray-900 rounded-xl p-4 border border-gray-800 hover-lift cursor-pointer">
                <div className="text-2xl mb-2">âœ¨</div>
                <h3 className="text-white font-semibold text-sm mb-1">Skin Analysis</h3>
                <p className="text-gray-400 text-xs">Detailed skin metrics & tips</p>
              </div>
              <div className="bg-gray-900 rounded-xl p-4 border border-gray-800 hover-lift cursor-pointer">
                <div className="text-2xl mb-2">ðŸ’¡</div>
                <h3 className="text-white font-semibold text-sm mb-1">Smart Tips</h3>
                <p className="text-gray-400 text-xs">AI-powered recommendations</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    );
  }

  if (showCamera) {
    return (
      <div className="min-h-screen bg-black flex flex-col">
        <div className="flex-1 relative">
          <video ref={videoRef} autoPlay playsInline className="w-full h-full object-cover" />
          <canvas ref={canvasRef} className="hidden" />
          <button onClick={stopCamera} className="absolute top-6 left-6 w-10 h-10 bg-black/50 backdrop-blur rounded-full flex items-center justify-center text-white hover:bg-black/70 transition-colors">
            <X className="w-6 h-6" />
          </button>
          <div className="absolute bottom-24 left-1/2 transform -translate-x-1/2 text-white text-center">
            <p className="text-sm mb-2">Position yourself in frame</p>
            <div className="w-64 h-1 bg-white/20 rounded-full overflow-hidden">
              <div className="h-full bg-blue-500 w-3/4 rounded-full" />
            </div>
          </div>
        </div>
        <div className="bg-black px-6 py-8">
          <button onClick={capturePhoto} className="w-full py-4 bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-700 hover:to-blue-600 text-white rounded-xl font-medium transition-all">
            Capture Photo
          </button>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-black">
      <div className="relative">
        <img src={image} alt="Analysis" className="w-full h-[50vh] object-cover" />
        <button onClick={reset} className="absolute top-6 left-6 w-10 h-10 bg-black/50 backdrop-blur rounded-full flex items-center justify-center text-white hover:bg-black/70 transition-colors">
          <X className="w-6 h-6" />
        </button>
        {analyzing && (
          <div className="absolute inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center">
            <div className="text-center">
              <div className="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
              <p className="text-white text-lg mb-2">Analyzing your image...</p>
              <p className="text-gray-400 text-sm">Extracting style insights</p>
            </div>
          </div>
        )}
      </div>

      {analysis && (
        <div className="bg-gray-950 min-h-[50vh]">
          <div className="px-6 py-4 border-b border-gray-800 flex gap-2 overflow-x-auto">
            {analysis.quickActions.map((action, i) => (
              <button key={i} className="flex items-center gap-2 px-4 py-2 bg-gray-800 hover:bg-gray-700 rounded-lg text-white text-sm whitespace-nowrap transition-colors">
                <span>{action.icon}</span><span>{action.label}</span>
              </button>
            ))}
          </div>

          <div className="flex border-b border-gray-800 px-6">
            {['outfit', 'colors', 'skin'].map(tab => (
              <button key={tab} onClick={() => setActiveTab(tab)} className={'flex-1 py-4 text-sm font-medium transition-colors ' + (activeTab === tab ? 'text-blue-500 border-b-2 border-blue-500' : 'text-gray-400')}>
                {tab.charAt(0).toUpperCase() + tab.slice(1)}
              </button>
            ))}
          </div>

          <div className="px-6 py-6">
            {activeTab === 'outfit' && (
              <div className="space-y-6">
                <div>
                  <h3 className="text-white text-2xl font-bold mb-2">{analysis.outfit.vibe}</h3>
                  <p className="text-gray-300 text-sm leading-relaxed">{analysis.outfit.description}</p>
                </div>

                <div className="bg-gray-900 rounded-xl p-6 border border-gray-800">
                  <h4 className="text-white font-semibold mb-4">Overall Rating</h4>
                  <div className="flex items-center gap-4 mb-6">
                    <div className="relative w-24 h-24">
                      <svg className="transform -rotate-90 w-24 h-24">
                        <circle cx="48" cy="48" r="40" stroke="#1f2937" strokeWidth="8" fill="none" />
                        <circle cx="48" cy="48" r="40" stroke="#3b82f6" strokeWidth="8" fill="none" strokeDasharray={2 * Math.PI * 40} strokeDashoffset={2 * Math.PI * 40 * (1 - analysis.outfit.rating / 10)} strokeLinecap="round" />
                      </svg>
                      <div className="absolute inset-0 flex items-center justify-center">
                        <span className="text-white text-2xl font-bold">{analysis.outfit.rating}</span>
                      </div>
                    </div>
                    <div className="flex-1">
                      <p className="text-gray-300 text-sm">Your outfit scored high on style and harmony!</p>
                    </div>
                  </div>

                  {analysis.outfit.categories.map((cat, i) => (
                    <div key={i} className="mb-4">
                      <div className="flex justify-between text-sm mb-1">
                        <span className="text-gray-300">{cat.name}</span>
                        <span className="text-blue-400 font-semibold">{cat.score}/10</span>
                      </div>
                      <div className="h-2 bg-gray-800 rounded-full overflow-hidden">
                        <div className="h-full bg-gradient-to-r from-blue-600 to-blue-400 rounded-full transition-all duration-1000" style={{ width: (cat.score * 10) + '%' }} />
                      </div>
                    </div>
                  ))}
                </div>

                <div>
                  <h4 className="text-white font-semibold mb-4 flex items-center gap-2">
                    <Sparkles className="w-4 h-4 text-yellow-400" />Style Suggestions
                  </h4>
                  <div className="space-y-3">
                    {analysis.outfit.suggestions.map((sug, i) => (
                      <div key={i} className={'bg-gray-900 rounded-xl p-4 border hover-lift cursor-pointer ' + (sug.priority === 'high' ? 'border-yellow-500/30' : 'border-gray-800')}>
                        <div className="flex items-start gap-3">
                          <div className="text-2xl">{sug.icon}</div>
                          <div className="flex-1">
                            <div className="flex items-center gap-2 mb-1">
                              <h5 className="text-white font-medium text-sm">{sug.title}</h5>
                              {sug.priority === 'high' && (
                                <span className="px-2 py-0.5 bg-yellow-500/20 text-yellow-400 text-xs rounded-full">Priority</span>
                              )}
                            </div>
                            <p className="text-gray-400 text-xs">{sug.desc}</p>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            )}

            {activeTab === 'colors' && (
              <div className="space-y-6">
                <div>
                  <h3 className="text-white text-xl font-bold mb-2">Primary Palette</h3>
                  <div className="flex gap-3 mb-4">
                    {analysis.colors.primary.map((color, i) => (
                      <div key={i} className="flex-1 hover-lift cursor-pointer">
                        <div className="w-full h-20 rounded-lg mb-2 shadow-lg" style={{ backgroundColor: color }} />
                        <p className="text-gray-400 text-xs text-center">{color}</p>
                      </div>
                    ))}
                  </div>
                  <p className="text-gray-300 text-sm">{analysis.colors.description}</p>
                </div>

                <div className="bg-gray-900 rounded-xl p-6 border border-gray-800">
                  <h4 className="text-white font-semibold mb-3">Accessorize with</h4>
                  <div className="flex items-center gap-4">
                    <div className="w-16 h-16 rounded-lg shadow-lg" style={{ backgroundColor: analysis.colors.accent }} />
                    <div>
                      <p className="text-white font-medium">{analysis.colors.accent}</p>
                      <p className="text-gray-400 text-sm">Add this pop of color to elevate your look</p>
                    </div>
                  </div>
                </div>

                <div>
                  <h4 className="text-white font-semibold mb-4 flex items-center gap-2">
                    <Sparkles className="w-4 h-4 text-purple-400" />Recommended Colors
                  </h4>
                  <div className="space-y-3">
                    {analysis.colors.recommendations.map((rec, i) => (
                      <div key={i} className="bg-gray-900 rounded-xl p-4 border border-gray-800 hover-lift cursor-pointer">
                        <div className="flex items-center gap-4">
                          <div className="w-12 h-12 rounded-lg shadow-lg flex-shrink-0" style={{ backgroundColor: rec.color }} />
                          <div className="flex-1">
                            <h5 className="text-white font-medium text-sm mb-1">{rec.name}</h5>
                            <p className="text-gray-400 text-xs">{rec.usage}</p>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>

                <div className="bg-gradient-to-br from-blue-950 to-purple-950 rounded-xl p-6 border border-blue-900">
                  <p className="text-blue-200 text-sm"><strong>Mood:</strong> {analysis.colors.mood}</p>
                </div>
              </div>
            )}

            {activeTab === 'skin' && (
              <div className="space-y-6">
                <div>
                  <h3 className="text-white text-xl font-bold mb-4">Skin Analysis</h3>
                  {analysis.skincare.metrics.map((metric, i) => (
                    <div key={i} className="mb-5">
                      <div className="flex justify-between text-sm mb-2">
                        <span className="text-gray-300">{metric.label}</span>
                        <span className="text-gray-300">{metric.opposite}</span>
                      </div>
                      <div className="h-2 bg-gray-800 rounded-full overflow-hidden relative">
                        <div className="absolute inset-0 flex">
                          <div className="flex-1 bg-gradient-to-r from-pink-600 to-pink-500" />
                          <div className="flex-1 bg-gradient-to-r from-pink-500 to-blue-600" />
                        </div>
                        <div className="absolute top-0 bottom-0 w-1 bg-white shadow-lg" style={{ left: metric.value + '%' }} />
                      </div>
                    </div>
                  ))}
                </div>

                <div className="bg-gray-900 rounded-xl p-6 border border-gray-800">
                  <h4 className="text-white font-semibold mb-4">Personalized Tips</h4>
                  <div className="space-y-2">
                    {analysis.skincare.tips.map((tip, i) => (
                      <p key={i} className="text-gray-300 text-sm">â€¢ {tip}</p>
                    ))}
                  </div>
                </div>

                <div>
                  <h4 className="text-white font-semibold mb-4">Product Recommendations</h4>
                  <div className="space-y-3">
                    {analysis.skincare.productSuggestions.map((prod, i) => (
                      <div key={i} className="bg-gray-900 rounded-xl p-4 border border-gray-800">
                        <div className="flex items-start gap-3">
                          <div className="text-2xl">{prod.icon}</div>
                          <div className="flex-1">
                            <h5 className="text-white font-medium text-sm mb-1">{prod.type}</h5>
                            <p className="text-gray-400 text-xs mb-1">{prod.benefit}</p>
                            <p className="text-blue-400 text-xs">{prod.when}</p>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            )}
          </div>
        </div>
      )}
    </div>
  );
}